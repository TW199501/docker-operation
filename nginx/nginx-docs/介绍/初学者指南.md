# 初學者指南

本指南旨在介紹 Nginx 基本內容和一些在 Nginx 上可以完成的簡單任務。這裡假設您已經安裝了 nginx，否則請參閱 [安裝 nginx ](安裝nginx.md) 頁面。 本指南介紹如何啟動、停止 nginx 和重新載入配置，解釋設定檔的結構，並介紹如何設置 nginx 以提供靜態內容服務，如何配置 nginx 作為代理伺服器，以及如何將其連接到一個 FastCGI 應用程式。

nginx 有一個主進程（Master）和幾個工作進程（Worker）。主進程的主要目的是讀取和評估配置，並維護工作進程。工作進程對請求進行處理。nginx 採用了基於事件模型和依賴於操作系統的機制來有效地在工作進程之間分配請求。工作進程的數量可在設定檔中定義，並且可以針對給定的配置進行修改，或者自動調整到可用 CPU 內核的數量（請參閱 worker_processes）。

設定檔決定了 nginx 及其模組的工作方式。默認情況下，配置檔案名為 `nginx.conf`，並放在目錄 `/usr/local/nginx/conf`，`/etc/nginx` 或 `/usr/local/etc/nginx` 中。

## 啟動、停止和重新載入配置

要啟動 nginx，需要運行可執行文件。nginx 啟動之後，可以透過調用可執行文件附帶 `-s 參數` 來控制它。 使用以下語法：

```bash
nginx -s 信號
```

信號可能是以下之一：

- stop - 立即關閉
- quit - 正常關閉
- reload - 重新載入設定檔
- reopen - 重新打開日誌檔案

例如，要等待工作進程處理完當前的請求才停止 nginx 進程，可以執行以下命令：

```bash
nginx -s quit
```

> 這個命令的執行用戶應該是與啟動nginx用戶是一致的

在將重新載入配置的命令發送到 nginx 或重新啟動之前，設定檔所做的內容更改將不會生效。要重新載入配置，請執行：

```bash
nginx -s reload
```

一旦主進程（Master）收到要重新載入配置（reload）的信號，它將檢查新設定檔的語法有效性，並嘗試應用其中提供的配置。如果成功，主進程將啟動新的工作進程（Worker），並向舊工作進程發送消息，請求它們關閉。否則，主進程回滾更改，並繼續使用舊配置。舊工作進程接收到關閉命令後，停止接受新的請求連接，並繼續維護當前請求，直到這些請求都被處理完成之後，舊工作進程將退出。

可以借助 Unix 工具（如 kill 工具）將信號發送到 nginx 進程，信號直接發送到指定進程 ID 的進程。默認情況下，nginx 主進程的進程 ID 是寫入在 `/usr/local/nginx/logs` 或 `/var/run` 中的 nginx.pid 文件中。例如，如果主進程 ID 為 1628，則發送 QUIT 信號讓 nginx 正常平滑關閉，可執行：

```bash
kill -s QUIT 1628
```

獲取所有正在運行的 nginx 進程列表，可以使用 `ps` 命令，如下：

```bash
ps -ax | grep nginx
```

有關向 nginx 發送信號的更多資訊，請參閱 [控制 nginx](控制nginx.md)。

## 設定檔結構

nginx 是由設定檔中指定的指令控制模組組成。指令可分為簡單指令和塊指令。一個簡單的指令是由空格分隔的名稱和參數組成，並以分號 `;` 結尾。塊指令具有與簡單指令相同的結構，但不是以分號結尾，而是以大括號`{}`包圍的一組附加指令結尾。如果塊指令的大括號內部可以有其它指令，則稱這個塊指令為上下文（例如：[events](http://nginx.org/en/docs/ngx_core_module.html#events)，[http](http://nginx.org/en/docs/http/ngx_http_core_module.html#http)，[server](http://nginx.org/en/docs/http/ngx_http_core_module.html#server) 和 [location](http://nginx.org/en/docs/http/ngx_http_core_module.html#location)）。

設定檔中被放置在任何上下文之外的指令都被認為是主上下文 [main](http://nginx.org/en/docs/ngx_core_module.html)。`events` 和 `http` 指令在主 `main` 上下文中，`server` 在 `http` 中，`location` 又在 `server` 中。

井號 `#` 之後的行的內容被視為注釋。

## 提供靜態內容服務

Web 伺服器的一個重要任務是提供文件（比如圖片或者靜態 HTML 頁面）服務。您將實現一個範例，根據請求，將提供來自不同的本地目錄的文件： `/data/www`（可能包含 HTML 文件）和 `/data/images`（包含圖片）。這需要編輯設定檔，在 `http` 中配置一個包含兩個 `location` 塊的 `server` 塊指令。

首先，創建 `/data/www` 目錄將包含任何文本內容的 `index.html` 文件放入其中，創建 `/data/images` 目錄然後放一些圖片進去。

其次，打開這個設定檔， 默認設定檔已經包含幾個伺服器塊範例，大部分是已經注釋掉的。現在注釋掉這些塊並且啟動一個新的 `server` 塊。

```nginx
http {
    server {
    }
}
```

通常，設定檔可以包含幾個由監聽 [listen](http://nginx.org/en/docs/http/ngx_http_core_module.html#listen) 埠和伺服器域名 [server names](http://nginx.org/en/docs/http/server_names.html) 區分的 `server` 塊指令 [distinguished](http://nginx.org/en/docs/http/request_processing.html)。一旦 nginx 決定由哪個 `server` 來處理請求，它會根據 `server` 塊中定義的 `location` 指令的參數來檢驗請求頭中指定的URI。

添加如下 `location` 塊指令到 `server` 塊指令中：

```nginx
location / {
    root /data/www;
}
```

該 `location` 塊指令指定 `/` 前綴與請求中的 URI 相比較。對於匹配的請求，URI 將被添加到根指令 [root](http://nginx.org/en/docs/http/ngx_http_core_module.html#root) 中指定的路徑，即 `/data/ www`，以形成本地文件系統上所請求文件的路徑。如果有幾個匹配上的 `location` 塊指令，nginx 將選擇具有最長前綴的 `location` 塊。上面的位置塊提供最短的前綴，長度為 1，因此只有當所有其它 `location` 塊不能匹配時，才會使用該塊。

接下來，添加第二個 `location` 指令快：

```nginx
location /images/ {
    root /data;
}
```

以 `/images/` 為開頭的請求將會被匹配上（雖然 `location /` 也能匹配上此請求，但是它的前綴更短）

最後，`server` 塊指令應如下所示：

```nginx
server {
    location / {
        root /data/www;
    }

    location /images/ {
        root /data;
    }
}
```

這已經是一個監聽標準 80 埠並且可以在本地機器上通過 `http://localhost/` 地址來訪問的有效配置。響應以 `/images/` 開頭的URI請求，伺服器將從 `/data/images` 目錄發送文件。例如，響應`http://localhost/images/example.png` 請求，nginx 將發送 `/data/images/example.png` 文件。如果此文件不存在，nginx 將發送一個404錯誤響應。不以 `/ images/` 開頭的 URI 的請求將映射到 `/data/www` 目錄。例如，響應 `http://localhost/some/example.html` 請求，nginx 將發送 `/data/www/some/example.html` 文件。

要讓新配置立刻生效，如果 nginx 尚未啟動可以啟動它，否則透過執行以下命令將重新載入配置信號發送到 nginx 的主進程：

```bash
nginx -s reload
```

> 如果運行的效果沒有在預期之中，您可以嘗試從 `/usr/local/nginx/logs` 或 `/var/log/ nginx` 中的 `access.log` 和 `error.log` 日誌檔案中尋找原因。

## 設置一個簡單的代理伺服器

nginx 的一個常見用途是作為一個代理伺服器，作用是接收請求並轉發給被代理的伺服器，從中取得響應，並將其發送回用戶端。

我們將配置一個基本的代理伺服器，它為圖片請求提供的文件來自本地目錄，並將所有其它請求發送給代理的伺服器。在此範例中，兩個伺服器在單個 nginx 實例上定義。

首先，通過向 nginx 的設定檔添加一個 `server` 塊來定義代理伺服器，其中包含以下內容：

```nginx
server {
    listen 8080;
    root /data/up1;

    location / {
    }
}
```

這是一個監聽 8080 埠的簡單伺服器（以前，由於使用了標準 80 埠，所以沒有指定 listen 指令），並將所有請求映射到本地文件系統上的 `/data/up1` 目錄。創建此目錄並將 `index.html` 文件放入其中。請注意，`root` 指令位於 `server` 上下文中。當選擇用於處理請求的 `location` 塊自身不包含 `root` 指令時，將使用此 `root` 指令。

接下來，在上一節中的伺服器配置基礎上進行修改，使其成為代理伺服器配置。在第一個 `location` 塊中，使用參數指定的代理伺服器的協議，域名和埠（在本例中為 `http://localhost:8080`）放置在 [proxy_pass](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass) 指令處：

```nginx
server {
    location / {
        proxy_pass http://localhost:8080;
    }

    location /images/ {
        root /data;
    }
}
```

我們將修改使用了 `/images/` 前綴將請求映射到 `/data/images` 目錄下的文件的第二個 `location` 塊，使其與附帶常見的圖片文件副檔名的請求相匹配。修改後的 `location` 塊如下所示：

```nginx
location ~ \.(gif|jpg|png)$ {
    root /data/images;
}
```

該參數是一個正則表達式，匹配所有以`.gif`，`.jpg` 或 `.png` 結尾的 URI。正則表達式之前應該是 `~`。相應的請求將映射到 `/data/images` 目錄。

當 nginx 選擇一個 `location` 塊來提供請求時，它首先檢查指定前綴的 [location](http://nginx.org/en/docs/http/ngx_http_core_module.html#location) 指令，記住具有最長前綴的 `location`，然後檢查正則表達式。如果與正則表達式匹配，nginx 會選擇此 `location`，否則選擇更早之前記住的那一個。

代理伺服器的最終配置如下：

```nginx
server {
    location / {
        proxy_pass http://localhost:8080/;
    }

    location ~ \.(gif|jpg|png)$ {
        root /data/images;
    }
}
```

此 `server` 將過濾以 `.gif`，`.jpg` 或 `.png` 結尾的請求，並將它們映射到 `/data/images` 目錄（通過向 root 指令的參數添加 URI），並將所有其它請求傳遞到上面配置的代理伺服器。

要使新配置立即生效，請將重新載入設定檔信號（reload）發送到 nginx，如前幾節所述。

還有更多的指令可用於進一步配置代理連接。

## 設置 FastCGI 代理

nginx 可被用於將請求路由到運行了使用各種框架和 PHP 等程式語言構建的應用程式的 FastCGI 伺服器。

與 FastCGI 伺服器協同工作的最基本的 nginx 配置是使用 [fastcgi_pass](http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass) 指令而不是 `proxy_pass` 指令，以及 `fastcgi_param` 指令來設置傳遞給 FastCGI 伺服器的參數。假設 FastCGI 伺服器可以在 localhost:9000 上訪問。以上一節的代理配置為基礎，用 `fastcgi_pass` 指令替換 `proxy_pass` 指令，並將參數更改為 `localhost:9000`。在 PHP 中，`SCRIPT_FILENAME` 參數用於確定腳本名稱，`QUERY_STRING` 參數用於傳遞請求參數。最終的配置將是：

```nginx
server {
    location / {
        fastcgi_pass  localhost:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param QUERY_STRING    $query_string;
    }

    location ~ \.(gif|jpg|png)$ {
        root /data/images;
    }
}
```

這裡設置一個 `server`，將除了靜態圖片請求之外的所有請求路由到通過 FastCGI 協議在 `localhost:9000` 上運行的代理伺服器。

## 原文件

- [http://nginx.org/en/docs/beginners_guide.html](http://nginx.org/en/docs/beginners_guide.html)
