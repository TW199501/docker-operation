## SQL Server 憑證說明

本節整理如何為 SQL Server 建立自簽名憑證，或透過 Let's Encrypt 搭配 Cloudflare DNS 驗證取得正式憑證，並在 Docker 環境中掛載使用。

---

### 1. 生成自簽名憑證
```bash
openssl req -x509 -newkey rsa:4096 -sha256 -nodes \
    -keyout sqlserver.key -out sqlserver.crt \
    -subj "/CN=your-server-name" \
    -days 365
```

#### 參數說明
- `-x509`：生成自簽名憑證。
- `-newkey rsa:4096`：使用 RSA 4096 位元。
- `-sha256`：採用 SHA-256 雜湊。
- `-nodes`：私鑰不加密。
- `-keyout` / `-out`：輸出私鑰與憑證檔案。
- `-subj`：憑證主體（請換成實際主機名稱或 IP）。
- `-days 365`：有效期限（天）。

---

### 2. 合併憑證與私鑰（可選）
```bash
cat sqlserver.crt sqlserver.key > sqlserver.pem
```

---

### 3. 設定檔案權限
```bash
chmod 644 sqlserver.key sqlserver.crt
```

---

### 4. 在 docker-compose 掛載憑證
```yaml
volumes:
  - /path/to/certs:/etc/mssql/certs
```

請將 `/path/to/certs` 換成實際存放憑證的主機目錄。

---

### 5. 在 SQL Server 中載入憑證
```sql
USE master;
GO
CREATE CERTIFICATE SqlServerTLSCert
FROM FILE = '/etc/mssql/certs/sqlserver.crt'
WITH PRIVATE KEY (
    FILE = '/etc/mssql/certs/sqlserver.key',
    DECRYPTION BY PASSWORD = ''  -- 私鑰若有密碼需填入
);
GO
```

載入完成後建議重啟 SQL Server 服務，確保憑證生效。

---

## Let's Encrypt + Cloudflare DNS 驗證流程

若需要正式憑證，可使用 Let's Encrypt 搭配 Cloudflare DNS-01 驗證。

### 前置準備
1. 網域由 Cloudflare 管理，且已建立 CNAME 指向 Cloudflare Tunnel（若有使用）。
2. 準備 Cloudflare 認證資訊：
   - **使用 API Token（建議）**：必須針對目標網域授予 `Zone → DNS → Edit` 權限。`cloudflare.ini` 內容寫成
     ```ini
     dns_cloudflare_api_token = your_cloudflare_api_token
     ```
   - **或使用 Global API Key**：
     ```ini
     dns_cloudflare_email = your_email@example.com
     dns_cloudflare_api_key = your_global_api_key
     ```
3. 建立 `cloudflare.ini` 檔案並設定權限（建議 600）。

### 申請憑證（certbot/dns-cloudflare）
```bash
docker run -it --rm \
  -v "/opt/letsencrypt:/etc/letsencrypt" \
  -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
  -v "/opt/cloudflare.ini:/cloudflare.ini" \
  certbot/dns-cloudflare certonly \
  --dns-cloudflare \
  --dns-cloudflare-credentials /cloudflare.ini \
  --dns-cloudflare-propagation-seconds 120 \
  -d xiong-da.com \
  -d sql.xiong-da.com -v
```
```bash
docker run -it --rm -v "/opt/letsencrypt:/etc/letsencrypt" -v "/var/lib/letsencrypt:/var/lib/letsencrypt" -v "/opt/cloudflare.ini:/cloudflare.ini" certbot/dns-cloudflare certonly --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini --dns-cloudflare-propagation-seconds 120 -d xiong-da.com -d sql.xiong-da.com -v
```
```bash
sudo mkdir -p /opt/letsencrypt /var/lib/letsencrypt
sudo touch /opt/cloudflare.ini
sudo chmod 700 /opt/letsencrypt /var/lib/letsencrypt
sudo chmod 600 /opt/cloudflare.ini
```

憑證會產生在 `/etc/letsencrypt/live/yourdomain.com/` 目錄下。

### 自動續期
```bash
docker run --rm \
  -v "/etc/letsencrypt:/etc/letsencrypt" \
  -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
  -v "/path/to/cloudflare.ini:/cloudflare.ini" \
  certbot/dns-cloudflare renew
```

可排程（cron）定期執行，確保憑證不過期。

### 憑證掛載與權限
- 掛載範例：
  ```yaml
  volumes:
    - /etc/letsencrypt/live/yourdomain.com/fullchain.pem:/etc/mssql/certs/sqlserver.crt
    - /etc/letsencrypt/live/yourdomain.com/privkey.pem:/etc/mssql/certs/sqlserver.key
  ```
- 建議設定檔案權限：
  ```bash
  chmod 644 /etc/letsencrypt/live/yourdomain.com/*
  ```
- DNS 驗證時請先將 Cloudflare 代理設為 `DNS only`。


### 使用 acme.sh（可選）
若偏好更輕量的 `acme.sh`，可搭配官方 Docker 映像執行。此方式與前述 Certbot 流程擇一使用即可。

1. **建立資料夾與權限**
   ```bash
   mkdir -p /opt/acme.sh
   chmod 700 /opt/acme.sh
   ```

2. **準備 Cloudflare 憑證**
   - API Token（建議）：確保具備 `Zone → DNS → Edit` 權限，於命令中以 `-e CF_Token="your_token"` 傳入。
   - Global API Key：改用 `-e CF_Key="your_global_key" -e CF_Email="your_email@example.com"`。

3. **註冊帳號（可選）**
   ```bash
   docker run --rm -it \
     -v "/opt/acme.sh:/acme.sh" \
     neilpang/acme.sh --register-account -m your_email@example.com
   ```

4. **申請 Wildcard 憑證**
   ```bash
   docker run --rm -it \
     -v "/opt/acme.sh:/acme.sh" \
     -e CF_Token="your_cloudflare_token" \
     neilpang/acme.sh --issue \
     --dns dns_cf \
     -d yourdomain.com \
     -d "*.yourdomain.com"
   ```

   憑證預設位於 `/opt/acme.sh/yourdomain.com/`：
   - `fullchain.cer`
   - `yourdomain.com.key`

5. **部署（可選）**：若需複製到固定掛載位置，可使用 `--install-cert` 指令：
   ```bash
   docker run --rm -it \
     -v "/opt/acme.sh:/acme.sh" \
     neilpang/acme.sh --install-cert -d yourdomain.com \
     --cert-file      /opt/acme.sh/deploy/yourdomain.com.crt \
     --key-file       /opt/acme.sh/deploy/yourdomain.com.key \
     --fullchain-file /opt/acme.sh/deploy/yourdomain.com.fullchain.pem
   ```

6. **續期**：acme.sh 在執行 `--cron` 時會檢查所有憑證。確認命令成功後再寫入排程：
   ```bash
   docker run --rm \
     -v "/opt/acme.sh:/acme.sh" \
     -e CF_Token="your_cloudflare_token" \
     neilpang/acme.sh --cron
   ```

   ```cron
   15 3 * * * docker run --rm -v /opt/acme.sh:/acme.sh -e CF_Token="your_cloudflare_token" neilpang/acme.sh --cron >> /var/log/acme-cron.log 2>&1
   ```

> 使用 Global API Key 時，將上述命令中的 `-e CF_Token=...` 改為 `-e CF_Key=... -e CF_Email=...`。

---

## 注意事項
1. 自簽名憑證僅建議用於測試環境。
2. DNS 由 Cloudflare 管理時，請先將希望發證的網域（如 `sql.yourdomain.com`）建立 CNAME 指向 Cloudflare Tunnel 提供的 `cfargotunnel.com` 子網域，之後才能用該網域申請憑證。
3. 檔案與目錄路徑請依實際環境調整，確保 Docker 掛載位置與 SQL Server 內部路徑一致。
4. 憑證變更後記得重啟 SQL Server 容器或服務。

