## SQL Server 憑證說明

本節整理如何為 SQL Server 建立自簽名憑證，或透過 Let's Encrypt 搭配 Cloudflare DNS 驗證取得正式憑證，並在 Docker 環境中掛載使用。

---

### 1. 生成自簽名憑證
```bash
openssl req -x509 -newkey rsa:4096 -sha256 -nodes \
    -keyout sqlserver.key -out sqlserver.crt \
    -subj "/CN=your-server-name" \
    -days 365
```

#### 參數說明
- `-x509`：生成自簽名憑證。
- `-newkey rsa:4096`：使用 RSA 4096 位元。
- `-sha256`：採用 SHA-256 雜湊。
- `-nodes`：私鑰不加密。
- `-keyout` / `-out`：輸出私鑰與憑證檔案。
- `-subj`：憑證主體（請換成實際主機名稱或 IP）。
- `-days 365`：有效期限（天）。

---

### 2. 合併憑證與私鑰（可選）
```bash
cat sqlserver.crt sqlserver.key > sqlserver.pem
```

---

### 3. 設定檔案權限
```bash
chmod 644 sqlserver.key sqlserver.crt
```

---

### 4. 在 docker-compose 掛載憑證
```yaml
volumes:
  - /path/to/certs:/etc/mssql/certs
```

請將 `/path/to/certs` 換成實際存放憑證的主機目錄。

---

### 5. 在 SQL Server 中載入憑證
```sql
USE master;
GO
CREATE CERTIFICATE SqlServerTLSCert
FROM FILE = '/etc/mssql/certs/sqlserver.crt'
WITH PRIVATE KEY (
    FILE = '/etc/mssql/certs/sqlserver.key',
    DECRYPTION BY PASSWORD = ''  -- 私鑰若有密碼需填入
);
GO
```

載入完成後建議重啟 SQL Server 服務，確保憑證生效。

---

## Let's Encrypt + Cloudflare DNS 驗證流程

若需要正式憑證，可使用 Let's Encrypt 搭配 Cloudflare DNS-01 驗證。

### 前置準備
1. 網域由 Cloudflare 管理，且已建立 CNAME 指向 Cloudflare Tunnel（若有使用）。
2. 準備 Cloudflare 認證資訊：
   - **使用 API Token（建議）**：必須針對目標網域授予 `Zone → DNS → Edit` 權限。`cloudflare.ini` 內容寫成
     ```ini
     dns_cloudflare_api_token = your_cloudflare_api_token
     ```
   - **或使用 Global API Key**：
     ```ini
     dns_cloudflare_email = your_email@example.com
     dns_cloudflare_api_key = your_global_api_key
     ```
3. 建立 `cloudflare.ini` 檔案並設定權限（建議 600）。

### 申請憑證（certbot/dns-cloudflare）
```bash
docker run -it --rm \
  -v "/opt/letsencrypt:/etc/letsencrypt" \
  -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
  -v "/opt/cloudflare.ini:/cloudflare.ini" \
  certbot/dns-cloudflare certonly \
  --dns-cloudflare \
  --dns-cloudflare-credentials /cloudflare.ini \
  --dns-cloudflare-propagation-seconds 120 \
  -d xiong-da.com \
  -d sql.xiong-da.com -v
```
```bash
docker run -it --rm -v "/opt/letsencrypt:/etc/letsencrypt" -v "/var/lib/letsencrypt:/var/lib/letsencrypt" -v "/opt/cloudflare.ini:/cloudflare.ini" certbot/dns-cloudflare certonly --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini --dns-cloudflare-propagation-seconds 120 -d xiong-da.com -d sql.xiong-da.com -v
```
```bash
sudo mkdir -p /opt/letsencrypt /var/lib/letsencrypt
sudo touch /opt/cloudflare.ini
sudo chmod 700 /opt/letsencrypt /var/lib/letsencrypt
sudo chmod 600 /opt/cloudflare.ini
```

憑證會產生在 `/etc/letsencrypt/live/yourdomain.com/` 目錄下。

### 自動續期
```bash
docker run --rm \
  -v "/etc/letsencrypt:/etc/letsencrypt" \
  -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
  -v "/path/to/cloudflare.ini:/cloudflare.ini" \
  certbot/dns-cloudflare renew
```

可排程（cron）定期執行，確保憑證不過期。

### 憑證掛載與權限
- 掛載範例：
  ```yaml
  volumes:
    - /etc/letsencrypt/live/yourdomain.com/fullchain.pem:/etc/mssql/certs/sqlserver.crt
    - /etc/letsencrypt/live/yourdomain.com/privkey.pem:/etc/mssql/certs/sqlserver.key
  ```
- 建議設定檔案權限：
  ```bash
  chmod 644 /etc/letsencrypt/live/yourdomain.com/*
  ```
- DNS 驗證時請先將 Cloudflare 代理設為 `DNS only`。


### 使用 acme.sh（可選）
若偏好 `acme.sh` 鏡像：
```bash
docker run --rm \
  -v "/path/to/certs:/acme.sh" \
  -e CF_Email="your_email@example.com" \
  -e CF_Key="your_cloudflare_api_key" \
  neilpang/acme.sh --issue \
  --dns dns_cf \
  -d yourdomain.com \
  -d sql.yourdomain.com
```

續期：
```bash
docker run --rm \
  -v "/path/to/certs:/acme.sh" \
  neilpang/acme.sh --renew -d yourdomain.com
```

---

## 注意事項
1. 自簽名憑證僅建議用於測試環境。
2. DNS 由 Cloudflare 管理時，請先將希望發證的網域（如 `sql.yourdomain.com`）建立 CNAME 指向 Cloudflare Tunnel 提供的 `cfargotunnel.com` 子網域，之後才能用該網域申請憑證。
3. 檔案與目錄路徑請依實際環境調整，確保 Docker 掛載位置與 SQL Server 內部路徑一致。
4. 憑證變更後記得重啟 SQL Server 容器或服務。

